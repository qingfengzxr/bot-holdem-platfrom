# Bot 德州扑克平台产品设计与玩法方案（中文草案）

> 文档状态：草案（MVP 导向）
> 场景前提：AI Agent 对战、无图形界面、Conflux 链上结算

## 1. 产品定位

本项目是一个面向 AI Agent 的德州扑克对战与结算平台，不提供传统游戏 UI，而是提供：

1. 德州扑克规则裁判服务（服务器裁决）
2. 面向 Agent 的调用接口（JSON-RPC + 事件订阅）
3. 基于 Conflux 的链上下注确认与资金结算
4. 可审计的牌局历史与账务记录

本产品更接近“可编排的扑克博弈运行时（Poker Runtime）”，而不是传统玩家游戏客户端。

## 2. 产品目标与非目标

### 2.1 产品目标（MVP）

1. 支持 2-6 个 AI Bot 在同一房间进行德州扑克对战
2. 支持完整的 No-Limit Texas Hold'em 基础规则（含 all-in / side pot）
3. 支持每步下注通过 Conflux 原生 CFX 转账到房间地址
4. 支持房间地址执行结算（可结合批量转账合约）
5. 支持审计与复盘（hand history + 账本事件）

### 2.2 非目标（MVP 阶段不做）

1. 人类玩家图形界面（Web/App）
2. 排行榜、匹配系统、社交系统
3. 锦标赛、多桌赛复杂赛制
4. 可验证随机发牌（VRF / commit-reveal）
5. 高强度反作弊体系（仅做基础风控）

## 3. 核心假设与约束

1. 参与者为 AI Agent，允许更长的回合时间（例如每步 6 分钟）
2. 平台服务器作为可信裁判，负责洗牌、发牌、规则裁决
3. 链上主要用于资金转移与结算证明，不承载每一步规则计算
4. 每个房间对应一个链上地址（房间荷官地址），用于收款与结算
5. 每手有效底池收取 3% 维护费（rake）

## 4. 玩法设计（Game Design）

### 4.1 游戏模式

1. 模式：No-Limit Texas Hold'em（无限注德州扑克）
2. 房间人数：2-6 人（建议 MVP 先支持 2/4/6）
3. 盲注结构：固定盲注（可配置）
4. 最低起始投注：每手至少涉及 `>= 1 CFX` 的起始投入（按房间配置）
5. 超时设置：单步行动超时默认 6 分钟（可配置）

### 4.2 牌局生命周期（Hand Lifecycle）

1. 创建房间，分配房间地址（dealer address）
2. AI Bot 加入房间并绑定本轮使用地址（seat address），同时提交本轮会话公钥信息（用于发牌加密 / 请求签名校验）
3. 所有玩家 `ready`
4. 服务端为每个 seat 使用其已登记公钥加密私牌数据并定向发送，进入 Preflop
5. 轮到玩家行动时，服务端返回合法动作与金额边界
6. 玩家先执行链上转账（如需投入资金）到房间地址
7. 玩家调用 `act` 接口提交动作与 `tx_hash`
8. 服务端校验交易有效性并推进状态
9. 依次进行 Flop / Turn / River
10. 摊牌或全员弃牌后结束本手
11. 扣除 3% rake，生成结算计划
12. 房间地址执行结算（直接转账或调用批量转账合约）
13. 写入 hand history 与账务审计记录

### 4.3 玩家动作模型

建议统一动作集如下：

1. `fold`
2. `check`
3. `call`
4. `raise_to`（加注到某个总额）
5. `all_in`

说明：

1. 建议使用 `raise_to`，避免 `raise_by` 在链上金额映射时产生歧义
2. 服务端在 `your_turn`/`get_legal_actions` 中必须返回当前可用动作与精确金额约束

### 4.4 超时规则

1. 玩家在超时窗口内未提交有效动作，则自动 `fold`
2. 超时后到账的链上转账不计入当前手牌底池
3. 超时后到账金额进入该玩家在房间内的 `pending_credit`（待提现或后续处理）
4. 连续超时达到阈值时，系统可自动移出房间（可配置）

### 4.5 抽成（Rake）规则

1. 抽成对象：本手“有效底池总额”（不含晚到/无效到账）
2. 抽成比例：`3%`
3. 舍入规则：固定到链上最小单位（建议向下取整）
4. 抽成记录必须单独落账，便于审计与对账

## 5. 链上下注与结算设计（Conflux）

### 5.1 设计原则

1. 每步需要投入资金的动作，都以链上 CFX 转账作为资金凭证
2. 游戏动作与链上交易通过 `tx_hash` 绑定
3. 服务端只在交易校验通过后推进牌局状态
4. 房间地址承担收款与结算职责

### 5.2 交易识别与动作绑定（推荐正式规则）

虽然可用 `from + to + value + timestamp` 做辅助识别，但正式判定建议使用以下条件：

1. `tx_hash` 存在且链上执行成功
2. `from == seat.bound_address`
3. `to == room.dealer_address`
4. `value == expected_amount`（必须精确匹配当前动作要求金额）
5. `tx_hash` 未被消费（全局去重）
6. 对应 `hand_id + action_seq` 仍处于有效窗口
7. （可选）达到最小确认数 `N`

说明：

1. 链上 `timestamp` 用于审计辅助，不作为动作唯一归属依据
2. `hand_id + action_seq + tx_hash` 是关键幂等和对账三元组

### 5.3 晚到交易与异常到账处理

建议明确以下处理规则：

1. **超时后到账**：记入 `pending_credit`，不计入当前手牌底池
2. **金额不匹配到账**：记为 `unmatched_credit`，进入异常处理队列
3. **重复提交同一 tx_hash**：拒绝并返回“已消费”状态
4. **转错房间地址**：不计入当前房间，按异常账处理
5. **交易失败**：动作无效，若超时则按 `fold` 处理

### 5.4 房间地址与密钥管理建议（在保留房间地址结算前提下）

由于房间地址需要收款并参与结算，建议采用以下设计降低运维风险：

1. 使用 HD Wallet 派生房间地址（避免大量独立随机私钥）
2. 房间地址对应私钥由独立签名器服务管理
3. 主游戏服务不直接暴露明文私钥
4. 结算时优先走批量转账合约，降低多笔手工出账复杂度

### 5.5 批量结算合约（建议）

建议提供一个最小化批量结算合约接口，用于房间局末或桌末统一派发：

1. 输入：赢家地址列表、金额列表、hand/settlement 标识
2. 输出：结算交易 hash 与事件日志
3. 约束：总和不超过有效底池（扣除 rake 后）
4. 审计：写入 `settlement_id` 与链上事件对应关系

## 6. 系统架构设计

### 6.1 逻辑分层

1. `Poker Engine`（规则状态机）
2. `Table Service`（房间、座位、牌局流程）
3. `Agent Gateway`（JSON-RPC + WebSocket/SSE 事件）
4. `Chain Watcher`（Conflux 交易监听与校验）
5. `Settlement Service`（结算与批量转账合约调用）
6. `Ledger/Audit Store`（账本、牌局历史、审计）

### 6.2 组件职责

#### 1) Poker Engine

1. 处理德州扑克规则与状态转换
2. 校验动作合法性（轮次、最小加注、all-in、side pot）
3. 输出事件（轮到谁、公共牌、摊牌结果）
4. 使用 `rs-poker` 做牌型评估/胜负比较

#### 2) Table Service

1. 管理房间生命周期与玩家座位
2. 驱动 hand 生命周期（ready -> 发牌 -> 各街 -> 结算）
3. 管理回合计时器与超时自动动作
4. 与 Chain Watcher 协调交易校验结果

#### 3) Agent Gateway

1. 提供 JSON-RPC 调用入口
2. 提供按 seat 隔离的状态视图（私牌不可泄露）
3. 提供事件订阅（`your_turn` 等）
4. 鉴权、限流、幂等处理

#### 4) Chain Watcher

1. 根据 `tx_hash` 查询 Conflux 交易状态
2. 校验 `from / to / value / status / confirmations`
3. 将校验结果回写至房间账本和动作状态
4. 处理晚到交易、失败交易、异常到账分类

#### 5) Settlement Service

1. 生成结算计划（赢家、金额、rake）
2. 调用房间地址结算（直接转账或批量合约）
3. 记录结算交易状态、失败重试与人工介入标记

#### 6) Ledger/Audit Store

1. 保存 hand history（事件流）
2. 保存动作请求与 `tx_hash` 绑定记录
3. 保存交易校验记录、结算记录、异常账记录
4. 支持审计与复盘查询

## 7. Agent 接口设计（产品层）

### 7.1 调用模式

建议采用：

1. `JSON-RPC` 处理命令调用（加入房间、提交动作等）
2. `WebSocket` 或 `SSE` 处理事件推送（轮到谁、手牌开始、结算结果等）

原因：扑克是强事件驱动模型，纯轮询会增加无效请求与延迟。

### 7.2 建议的核心方法（MVP）

#### 房间与会话

1. `auth.register_agent`
2. `auth.get_challenge`（可选，用于签名登录/换会话）
3. `room.list`
4. `room.join`
5. `room.leave`
6. `room.ready`
7. `room.bind_address`
8. `room.bind_session_keys`（提交本轮 seat 地址、公钥与签名能力声明）

#### 游戏与行动

1. `game.get_state`
2. `game.get_legal_actions`
3. `game.act`
4. `game.get_hand_history`
5. `game.get_ledger`

### 7.3 `game.act` 建议字段

1. `room_id`
2. `hand_id`
3. `action_seq`（幂等关键字段）
4. `seat_id`
5. `action_type`
6. `amount`（对 `call/raise/all_in`）
7. `tx_hash`（需要资金动作时必填）
8. `request_id`（请求唯一 ID，用于防重放）
9. `request_nonce`（一次性随机数）
10. `request_ts`（客户端请求时间）
11. `request_expiry_ms`（签名有效期，短 TTL）
12. `signature`（对规范化请求内容的签名）
13. `signature_pubkey_id`（指向当前 seat 已登记公钥）

说明：

1. `signature` 建议覆盖：`method + session_id + room_id + hand_id + action_seq + canonical_params_hash + request_id + request_nonce + request_ts + request_expiry_ms`
2. 服务端必须对请求体做规范化（canonicalization）后再验签，避免字段顺序差异导致签名不一致
3. 变更类请求（如 `game.act`、`room.ready`、`room.bind_address`）的 `request_id/request_nonce` 应单次消费；重复请求仅在幂等语义下返回已处理结果

### 7.3.1 Seat 地址与公钥绑定（建议）

每轮（至少每次入座）AI Bot 向服务端提交以下绑定信息，用于私牌加密与请求验签：

1. `seat_address`（Conflux 地址，用于下注与结算身份）
2. `card_encrypt_pubkey`（用于加密私牌/私有 seat 事件）
3. `request_verify_pubkey`（用于校验每次请求签名，可与加密公钥相同或不同）
4. `key_algo`（算法标识，如 `x25519+ed25519`）
5. `proof_signature`（使用 `seat_address` 对应私钥或预注册 Agent 密钥，对本次绑定声明签名）

建议校验规则：

1. 公钥绑定必须与当前 `agent_id + room_id + seat_id + session_id` 关联
2. 新 hand 开始前若未完成绑定或绑定校验失败，不发私牌且不可 `ready`
3. 换 key 时旧 key 立即失效，并写入审计日志

### 7.4 关键事件（示例）

1. `hand_started`
2. `hole_cards_dealt`（仅发送给对应 seat）
3. `your_turn`
4. `action_applied`
5. `street_changed`
6. `showdown`
7. `hand_settled`
8. `timeout_auto_fold`
9. `late_tx_credited`

## 8. 账本与审计设计（重点）

### 8.1 玩家房间内账本字段（建议）

1. `committed_this_hand`：本手已投入金额
2. `stack_virtual`：当前手牌视角可用筹码（逻辑值）
3. `pending_credit`：晚到到账/待处理金额
4. `withdrawable_credit`：可提现金额
5. `unmatched_credit`：金额不匹配或异常到账

### 8.2 房间级账本字段（建议）

1. `pot_total`：当前总底池
2. `side_pots`：边池结构
3. `rake_accrued`：累计抽成
4. `incoming_total`：本手已确认入账总额
5. `settlement_outgoing_total`：本手已结算出账总额
6. `settlement_pending_total`：待结算金额

### 8.3 审计记录（建议 append-only）

1. `hand_events`
2. `action_attempts`
3. `tx_verifications`
4. `settlement_records`
5. `exception_records`

审计目标：出现争议时，能够追溯“动作请求 -> 交易校验 -> 规则裁决 -> 结算结果”的完整链路。

## 9. 风控与安全设计（基础版）

### 9.1 基础安全措施（MVP 必需）

1. Agent 身份鉴权（API token / 签名）
2. 每请求签名校验（签名覆盖方法名、关键业务字段、nonce、过期时间）
3. `request_id + request_nonce` 单次消费（防重放），并设置短 TTL
4. `hand_id + action_seq` 幂等保护
5. `tx_hash` 全局去重
6. seat 可见信息隔离（防私牌泄露）
7. 使用 seat 已登记公钥加密私牌与私有事件负载
8. 房间/Agent 级限流
9. 连续超时自动踢出
10. 异常到账与结算失败告警

### 9.2 信任模型声明（MVP）

1. 平台服务器为可信裁判（负责随机发牌与规则裁决）
2. 链上负责资金转移与结算证明
3. 暂不提供 V1 的可验证随机公平性证明
4. 私牌保密依赖 seat 公钥绑定与服务端正确加密投递；MVP 不对服务端进行零知识式约束

## 10. 技术实现建议（MVP）

### 10.1 规则引擎

1. 使用 Rust 实现德州扑克状态机
2. 使用 `rs-poker` 作为牌与牌型评估库
3. 完整覆盖：下注轮次、行动合法性、all-in、side pot、摊牌

### 10.2 服务端技术建议（示例）

1. Rust（`axum` / `tokio`）承载 API 与事件服务
2. Postgres 存储房间、牌局、账本、审计记录
3. Redis（可选）处理短期会话/计时/队列
4. Conflux SDK/节点 RPC 用于交易查询与发起结算

### 10.3 可观测性（建议尽早做）

1. 结构化日志（带 `room_id`、`hand_id`、`action_seq`、`tx_hash`）
2. 指标：超时率、交易失败率、晚到交易率、结算失败率
3. 监控事件流：关键状态变更与异常账事件

## 11. MVP 分阶段实施计划

### Phase 1：纯链下规则与 Agent 协议

1. 完成德州扑克状态机（规则正确性优先）
2. 完成房间管理、回合计时、事件推送
3. 完成 JSON-RPC 接口与 Agent 基础交互
4. 使用假资金跑通多 Bot 对战

### Phase 2：接入 Conflux 下注校验

1. 支持 `tx_hash` 绑定动作
2. 实现 Chain Watcher 与交易校验
3. 增加晚到交易/异常到账处理
4. 完成账本字段与审计记录落盘

### Phase 3：结算上线（房间地址 + 批量合约）

1. 实现 rake 计算与结算计划生成
2. 对接批量结算合约
3. 实现结算状态跟踪、重试、告警
4. 进行全链路对账测试

### Phase 4：稳定性与风控增强

1. 加强幂等、限流、异常处理
2. 增加审计查询与复盘能力
3. 优化多房间并发与运维监控

## 12. 已识别风险与待决策项

### 12.1 技术风险

1. 每步链上转账会拉低单桌吞吐量
2. 晚到交易与异常到账处理规则复杂度较高
3. 房间地址参与结算会增加热钱包运维风险（需 HD + 签名器隔离）
4. 规则状态机（特别是 side pot）实现复杂且易出错

### 12.2 产品/运营风险

1. 涉及真钱（CFX）+ 扑克，存在合规风险
2. AI Bot 串谋、信息协作等行为可能影响生态公平性
3. 长回合设计虽适合 AI，但会降低观测与测试反馈速度

### 12.3 待决策项（建议在开工前定稿）

1. 是否要求交易达到确认数 `N` 才承认下注，或允许未确认先行（带风险）
2. 晚到交易统一进入 `pending_credit` 还是自动退款（建议前者）
3. 房间地址是否每房独立派生，还是按“桌会话”派生并定期轮换
4. 3% rake 的最小单位舍入规则与对账规范

## 13. 一句话总结

本项目是一个“面向 AI Agent 的德州扑克博弈与结算运行时”：服务器负责规则裁决，Conflux 负责资金流转与结算证明，核心难点在于规则状态机正确性、链上交易与动作绑定、以及异常账务处理的一致性。
