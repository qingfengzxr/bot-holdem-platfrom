# Bot 德州扑克平台模块开发进度文档（MVP）

## 1. 工程与基础设施模块

- [x] 初始化 Rust workspace（`Cargo.toml` + crates 目录）
- [x] 建立 `justfile` 任务脚本（build/test/lint/dev）
- [x] 建立 `mise.toml` 环境版本管理（rust/tooling）
- [x] 配置 `rustfmt` / `clippy` / CI 基础流水线
- [x] 建立统一错误码与错误响应格式
- [x] 建立配置系统（本地/dev/test/prod）
- [x] 建立迁移工具与 `migrations/` 目录结构

## 2. `poker-domain`（领域模型）

- [x] 定义房间、座位、牌局、动作、街道等核心枚举与结构体
- [x] 定义金额类型（整数最小单位，避免浮点）
- [x] 定义领域事件模型（`hand_events` 对应）
- [x] 定义错误码（动作非法、非你回合、金额错误等）
- [x] 定义审计事件枚举（供 `audit_behavior_events` 使用）
- [x] 定义 JSON 序列化契约（稳定字段命名；领域枚举/事件变体使用 `snake_case`，附序列化单测）

## 3. `poker-engine`（规则状态机，基于 rs-poker）

- [x] 接入 `rs-poker` 依赖并完成基础封装
- [x] 实现 `HandState` / `BettingRoundState` / `PotState`
- [x] 实现发牌流程（内部明文，不对外泄露；引擎内维护 `deck/burn/board/hole_cards`，支持可注入 deck 测试）
- [x] 实现合法动作计算（当前 seat 视角）
- [x] 实现 `fold/check/call/raise_to/all_in` 状态推进
- [x] 实现最小加注与加注边界校验
- [x] 实现 all-in 与 side pot 分池逻辑（含短码 all-in、side pot 重建基础）
- [x] 实现提前结束（全员弃牌只剩一人）路径
- [x] 实现摊牌与 `rs-poker` 牌型评估（赢家/平局判定最小路径）
- [x] 输出 `HandStarted/ActionAccepted/StreetChanged/...` 领域事件（`poker-engine` 事件 kind helper，`table-service` 可复用）
- [x] 补齐规则单元测试（含边界 case，已覆盖下注轮次/短码 all-in/side pot 层级/eligible 子集平局等核心边界）

## 4. `table-service`（房间 actor / 编排）

- [x] 实现 `room_id -> actor` 路由与生命周期管理
- [x] 实现房间命令队列（有界 channel）
- [x] 实现 `room.join / leave / ready / bind_address`
- [x] 实现 hand 启动条件检查（seat/key/ready）
- [x] 实现回合计时器与超时自动 `fold`
- [x] 实现 `game.get_state / get_legal_actions` 读取路径
- [x] 实现 `game.act` 命令串行处理
- [x] 实现链上校验结果回投命令（供 `chain-watcher` 使用）
- [x] 实现事件写库 + outbox 写入的事务边界
- [ ] 实现房间恢复（进程重启后从 DB 恢复最小状态）

## 5. `rpc-gateway`（jsonrpsee）

- [x] 初始化 `jsonrpsee` HTTP + WS 服务
- [x] 定义 `auth.* / room.* / game.* / ledger.*` 方法注册
- [x] 定义 PubSub 事件主题与订阅接口
- [x] 实现参数校验与统一错误码映射
- [x] 实现请求上下文注入（`trace_id/session_id/agent_id`）
- [x] 实现方法级权限控制
- [x] 实现原生 WS PubSub 注册（`jsonrpsee register_subscription`，内存总线桥接版）
- [x] 实现连接级限流与并发限制（并发 limiter + 固定窗口速率限制，已接入 jsonrpsee 方法注册入口）
- [x] 实现慢订阅者断开策略（内存事件总线有界队列 + 队列满断开）

## 6. `agent-auth`（签名校验 / 防重放）

- [x] 实现请求参数 canonicalization
- [x] 实现签名 payload 拼装规范
- [x] 实现 `Ed25519` 验签
- [x] 实现 `request_ts + expiry` 时间窗校验
- [x] 实现 `request_id + request_nonce` 防重放（Redis 或 DB）
- [x] 实现幂等键检查（`hand_id + action_seq`）
- [x] 实现 `room.bind_session_keys` 绑定声明校验
- [ ] 审计落库：验签失败 / 重放拒绝 / 过期拒绝（已接入 `jsonrpsee` 实际请求入口并写入审计；重放拒绝仍待与防重放存储联动）

## 7. `seat-crypto`（私牌与私有事件加密）

- [x] 定义 seat 私有事件密文 payload 格式
- [x] 实现会话密钥派生/加密封装（X25519 + AEAD）
- [x] 实现 `hole_cards_dealt` 密文生成
- [x] 实现 seat 私有事件加密（含 `room_id/hand_id/seat_id/event_seq` 绑定）
- [x] 实现密文解码测试向量（服务端/客户端互通）
- [x] 审计记录发牌加密投递行为日志（`seat-crypto` 审计 helper + `app-server` 审计落库适配器与测试；待发牌主流程接入调用）

## 8. `ledger-store` / `audit-store`（数据库与审计）

- [x] 编写核心 DDL（`agents/rooms/hands/hand_seats`）
- [x] 编写审计 DDL（`audit_action_attempts/audit_behavior_events/hand_events`）
- [x] 编写链上与结算 DDL（`tx_verifications/tx_bindings/exception_credits/settlement_*`）
- [x] 编写账本 DDL（`ledger_entries`）
- [x] 编写 `room_signing_keys` DDL（MVP 临时方案）
- [x] 实现 repository 层（事务写入）
- [x] 实现 outbox 写入与读取
- [x] 实现 Postgres repository（`sqlx`）写入骨架（`audit-store` / `ledger-store`）
- [x] 实现常用查询索引与分页查询（`0002_query_indexes.sql` + 仓储分页读查询）
- [x] 实现审计查询接口所需 read model（仓储层骨架，InMemory/Postgres）

## 9. `chain-watcher`（Conflux eSpace / EVM 交易校验）

- [x] 封装 Conflux RPC 客户端
- [x] 实现 `tx_hash` 查询与重试退避
- [x] 实现 `from/to/value/status` 校验
- [x] 实现确认数 `N` 校验策略
- [x] 实现 `matched/late/unmatched/failed/pending` 分类
- [x] 写入 `tx_verifications`（接口+内存实现，已接回调路径）
- [x] 写入/更新 `exception_credits`（接口+内存实现，已接回调路径）
- [x] 回投 `table-service` 推进状态
- [x] 审计落库链上回调与异常行为

## 10. `settlement-service`（结算与签名）

- [x] 实现结算计划生成（赢家金额 + rake，最小版：按赢家列表平分）
- [x] 实现 `ledger_entries` 结算分录写入（含 `record_plan` 测试）
- [x] 实现房间私钥密文解密（仅本模块，含 `room_signing_keys` 记录解密工具）
- [x] 实现 `AES-256-GCM` 密文解析（`nonce/aad/kek_id`）
- [x] 实现结算交易构造与提交（直转，接口+Mock 骨架）
- [x] 实现结算状态轮询/确认（接口+Mock 骨架）
- [x] 实现失败重试与人工介入标记（`settlement_records` 状态更新 + `retry_count` + `manual_review_required` 标记）
- [x] 审计记录私钥使用、签名、出账行为（已覆盖结算出账提交/回执/人工介入审计；私钥/签名细粒度待真实签名器接入增强）
- [x] 预留批量合约适配接口（trait + request/submission/receipt + service helper）
- [x] 自动结算协调器骨架（`Showdown` 状态检测 + reveal/provider 抽象 + 直转编排接入点）
- [x] 自动结算后台轮询触发器骨架（房间扫描 + shutdown 信号 + 调用协调器）
- [x] `app-server` 自动结算主进程接线（env 开关 + loop 启动；`ShowdownInputProvider` 已接 room seat 地址回退，reveal 已支持通过 `ops-http` 管理接口注入，且有自动结算集成测试覆盖）

## 11. `ops-http`（运维与可观测性）

- [x] 初始化 `axum` 服务（与 RPC 并存或独立端口）
- [x] 实现 `/health`
- [x] 实现 `/metrics`
- [x] 实现 `/admin/rooms/:id`
- [x] 实现 `/admin/hands/:id/replay`
- [x] 实现 `/admin/audit/request/:request_id`
- [x] 实现 `/admin/audit/tx/:tx_hash`
- [x] 实现 `/admin/settlements/hand/:id/showdown-input`（管理员注入 reveal 输入，供 auto-settlement 使用）
- [x] 接入结构化日志与 trace

## 12. `agent-sdk`（平台协议适配层，区别于文本 Agent Skill）

- [x] 定义 Skill 接口（connect/join/bind/ready/observe/act）
- [x] 实现 JSON-RPC 请求封装
- [x] 实现请求签名与 nonce/request_id 自动填充
- [x] 实现 seat 私有事件解密
- [x] 实现 observation 结构化输出
- [x] 实现动作合法性二次校验（客户端侧）
- [x] 实现错误重试与幂等重放保护
- [ ] 输出示例 Skill 使用文档

## 13. `headless-agent-client`（执行器）

- [x] 实现常驻进程事件循环
- [x] 实现 WS 重连与订阅恢复
- [x] 实现 `wallet_adapter`（eSpace/EVM 转账与 `tx_hash` 获取，含 Anvil 集成测试骨架）
- [x] 实现 `policy_adapter`（接 LLM/Codex/脚本策略，接口+规则策略版）
- [x] 实现超时保护 fallback（默认 `fold`）
- [x] 实现状态缓存与回合上下文管理
- [x] 实现本地审计日志（便于调试）
- [x] 完成最小可用对局脚本（单房间多 Bot，本地 in-memory room actor 演示版）

## 14. 测试与质量保障模块

- [x] 规则引擎单元测试（下注轮次、all-in、side pot，核心版）
- [x] 安全模块单元测试（验签、防重放、过期）
- [x] 加密模块单元测试（发牌加密/解密）
- [x] 数据层测试（事务一致性、唯一约束、审计完整性；已覆盖 InMemory 路径与跨仓储一致性，Postgres 事务集成待增强）
- [x] 集成测试（房间流程 + RPC）
- [x] 集成测试（链上校验回投）
- [x] 端到端测试（Headless Client 多 Bot 对局，当前为本地 in-memory room actor 的自动化 demo 测试；RPC/链上路径 E2E 待补）
- [ ] 性能压测（多房间并发）

## 15. 文档与交付物

- [x] 产品设计与玩法方案文档（草案）
- [x] 技术架构与技术方案文档（草案）
- [x] 总开发进度控制文档
- [x] 模块开发进度文档
- [x] JSON-RPC 接口契约文档（基于当前 `jsonrpsee` 实现，覆盖命令/订阅/原生 WS PubSub/签名字段/限流约束）
- [x] Postgres DDL 文档 / migration 初版（含表边界、关键约束、索引说明、MVP 风险点）
- [ ] Agent SDK 接入说明文档
- [ ] Headless Agent Client 使用说明文档
