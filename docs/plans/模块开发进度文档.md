# Bot 德州扑克平台模块开发进度文档（MVP）

## 1. 工程与基础设施模块

- [x] 初始化 Rust workspace（`Cargo.toml` + crates 目录）
- [x] 建立 `justfile` 任务脚本（build/test/lint/dev）
- [x] 建立 `mise.toml` 环境版本管理（rust/tooling）
- [ ] 配置 `rustfmt` / `clippy` / CI 基础流水线
- [ ] 建立统一错误码与错误响应格式
- [ ] 建立配置系统（本地/dev/test/prod）
- [ ] 建立迁移工具与 `migrations/` 目录结构

## 2. `poker-domain`（领域模型）

- [x] 定义房间、座位、牌局、动作、街道等核心枚举与结构体
- [x] 定义金额类型（整数最小单位，避免浮点）
- [x] 定义领域事件模型（`hand_events` 对应）
- [x] 定义错误码（动作非法、非你回合、金额错误等）
- [ ] 定义审计事件枚举（供 `audit_behavior_events` 使用）
- [ ] 定义 JSON 序列化契约（稳定字段命名）

## 3. `poker-engine`（规则状态机，基于 rs-poker）

- [x] 接入 `rs-poker` 依赖并完成基础封装
- [x] 实现 `HandState` / `BettingRoundState` / `PotState`
- [ ] 实现发牌流程（内部明文，不对外泄露）
- [ ] 实现合法动作计算（当前 seat 视角）
- [ ] 实现 `fold/check/call/raise_to/all_in` 状态推进
- [ ] 实现最小加注与加注边界校验
- [ ] 实现 all-in 与 side pot 分池逻辑
- [ ] 实现提前结束（全员弃牌只剩一人）路径
- [ ] 实现摊牌与 `rs-poker` 牌型评估
- [ ] 输出 `HandStarted/ActionAccepted/StreetChanged/...` 领域事件
- [ ] 补齐规则单元测试（含边界 case）

## 4. `table-service`（房间 actor / 编排）

- [x] 实现 `room_id -> actor` 路由与生命周期管理
- [x] 实现房间命令队列（有界 channel）
- [x] 实现 `room.join / leave / ready / bind_address`
- [ ] 实现 hand 启动条件检查（seat/key/ready）
- [ ] 实现回合计时器与超时自动 `fold`
- [x] 实现 `game.get_state / get_legal_actions` 读取路径
- [ ] 实现 `game.act` 命令串行处理
- [ ] 实现链上校验结果回投命令（供 `chain-watcher` 使用）
- [ ] 实现事件写库 + outbox 写入的事务边界
- [ ] 实现房间恢复（进程重启后从 DB 恢复最小状态）

## 5. `rpc-gateway`（jsonrpsee）

- [ ] 初始化 `jsonrpsee` HTTP + WS 服务
- [ ] 定义 `auth.* / room.* / game.* / ledger.*` 方法注册
- [ ] 定义 PubSub 事件主题与订阅接口
- [ ] 实现参数校验与统一错误码映射
- [ ] 实现请求上下文注入（`trace_id/session_id/agent_id`）
- [ ] 实现方法级权限控制
- [ ] 实现连接级限流与并发限制
- [ ] 实现慢订阅者断开策略

## 6. `agent-auth`（签名校验 / 防重放）

- [x] 实现请求参数 canonicalization
- [x] 实现签名 payload 拼装规范
- [ ] 实现 `Ed25519` 验签
- [ ] 实现 `request_ts + expiry` 时间窗校验
- [ ] 实现 `request_id + request_nonce` 防重放（Redis 或 DB）
- [ ] 实现幂等键检查（`hand_id + action_seq`）
- [ ] 实现 `room.bind_session_keys` 绑定声明校验
- [ ] 审计落库：验签失败 / 重放拒绝 / 过期拒绝

## 7. `seat-crypto`（私牌与私有事件加密）

- [ ] 定义 seat 私有事件密文 payload 格式
- [ ] 实现会话密钥派生/加密封装（X25519 + AEAD）
- [ ] 实现 `hole_cards_dealt` 密文生成
- [ ] 实现 seat 私有事件加密（含 `room_id/hand_id/seat_id/event_seq` 绑定）
- [ ] 实现密文解码测试向量（服务端/客户端互通）
- [ ] 审计记录发牌加密投递行为日志

## 8. `ledger-store` / `audit-store`（数据库与审计）

- [x] 编写核心 DDL（`agents/rooms/hands/hand_seats`）
- [x] 编写审计 DDL（`audit_action_attempts/audit_behavior_events/hand_events`）
- [x] 编写链上与结算 DDL（`tx_verifications/tx_bindings/exception_credits/settlement_*`）
- [x] 编写账本 DDL（`ledger_entries`）
- [x] 编写 `room_signing_keys` DDL（MVP 临时方案）
- [ ] 实现 repository 层（事务写入）
- [ ] 实现 outbox 写入与读取
- [ ] 实现常用查询索引与分页查询
- [ ] 实现审计查询接口所需 read model

## 9. `chain-watcher`（Conflux 交易校验）

- [ ] 封装 Conflux RPC 客户端
- [ ] 实现 `tx_hash` 查询与重试退避
- [ ] 实现 `from/to/value/status` 校验
- [ ] 实现确认数 `N` 校验策略
- [ ] 实现 `matched/late/unmatched/failed/pending` 分类
- [ ] 写入 `tx_verifications`
- [ ] 写入/更新 `exception_credits`
- [ ] 回投 `table-service` 推进状态
- [ ] 审计落库链上回调与异常行为

## 10. `settlement-service`（结算与签名）

- [ ] 实现结算计划生成（赢家金额 + rake）
- [ ] 实现 `ledger_entries` 结算分录写入
- [ ] 实现房间私钥密文解密（仅本模块）
- [ ] 实现 `AES-256-GCM` 密文解析（`nonce/aad/kek_id`）
- [ ] 实现结算交易构造与提交（直转）
- [ ] 实现结算状态轮询/确认
- [ ] 实现失败重试与人工介入标记
- [ ] 审计记录私钥使用、签名、出账行为
- [ ] 预留批量合约适配接口

## 11. `ops-http`（运维与可观测性）

- [x] 初始化 `axum` 服务（与 RPC 并存或独立端口）
- [x] 实现 `/health`
- [ ] 实现 `/metrics`
- [ ] 实现 `/admin/rooms/:id`
- [ ] 实现 `/admin/hands/:id/replay`
- [ ] 实现 `/admin/audit/request/:request_id`
- [ ] 实现 `/admin/audit/tx/:tx_hash`
- [ ] 接入结构化日志与 trace

## 12. `agent-skill`（平台协议适配层）

- [ ] 定义 Skill 接口（connect/join/bind/ready/observe/act）
- [ ] 实现 JSON-RPC 请求封装
- [ ] 实现请求签名与 nonce/request_id 自动填充
- [ ] 实现 seat 私有事件解密
- [ ] 实现 observation 结构化输出
- [ ] 实现动作合法性二次校验（客户端侧）
- [ ] 实现错误重试与幂等重放保护
- [ ] 输出示例 Skill 使用文档

## 13. `headless-agent-client`（执行器）

- [ ] 实现常驻进程事件循环
- [ ] 实现 WS 重连与订阅恢复
- [ ] 实现 `wallet_adapter`（CFX 转账与 `tx_hash` 获取）
- [ ] 实现 `policy_adapter`（接 LLM/Codex/脚本策略）
- [ ] 实现超时保护 fallback（默认 `fold`）
- [ ] 实现状态缓存与回合上下文管理
- [ ] 实现本地审计日志（便于调试）
- [ ] 完成最小可用对局脚本（单房间多 Bot）

## 14. 测试与质量保障模块

- [ ] 规则引擎单元测试（下注轮次、all-in、side pot）
- [ ] 安全模块单元测试（验签、防重放、过期）
- [ ] 加密模块单元测试（发牌加密/解密）
- [ ] 数据层测试（事务一致性、唯一约束、审计完整性）
- [ ] 集成测试（房间流程 + RPC）
- [ ] 集成测试（链上校验回投）
- [ ] 端到端测试（Headless Client 多 Bot 对局）
- [ ] 性能压测（多房间并发）

## 15. 文档与交付物

- [x] 产品设计与玩法方案文档（草案）
- [x] 技术架构与技术方案文档（草案）
- [x] 总开发进度控制文档
- [x] 模块开发进度文档
- [ ] JSON-RPC 接口契约文档
- [ ] Postgres DDL 文档 / migration 初版
- [ ] Agent Skill 接入说明文档
- [ ] Headless Agent Client 使用说明文档
