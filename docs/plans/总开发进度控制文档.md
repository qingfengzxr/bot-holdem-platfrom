# Bot 德州扑克平台总开发进度控制文档（MVP）

## 0. 项目基础与方案定稿

- [x] 完成产品设计与玩法方案文档（MVP 草案）
- [x] 完成技术架构与技术方案文档（独立于产品文档）
- [x] 明确核心技术栈（Rust + rs-poker + jsonrpsee + axum + Postgres）
- [x] 明确安全方案（seat 公钥加密发牌、请求签名、防重放）
- [x] 明确审计与账本表结构边界（三类日志分离）
- [x] 明确 Agent Skill 与 Headless Agent Client 方案
- [ ] 冻结 MVP 范围（确认 v1 必做/不做清单）
- [ ] 冻结关键协议字段与错误码（JSON-RPC 契约定稿）
- [ ] 冻结资金与结算策略细节（确认数、舍入、异常账处理）

## 1. Phase 1：链下规则与 Agent 协议（优先级最高）

- [ ] 建立 Rust workspace 与基础 crate 结构
- [ ] 建立代码规范与工程脚手架（lint/test/format/just/mise）
- [ ] 实现 `poker-domain` 领域模型与错误码
- [ ] 实现 `poker-engine` 基础状态机（2 人流程先跑通）
- [ ] 实现合法动作计算（`fold/check/call/raise_to/all_in`）
- [ ] 实现 side pot 与 all-in 结算逻辑
- [ ] 接入 `rs-poker` 进行牌型评估与摊牌比较
- [ ] 建立 `table-service`（单房间单写者 actor）
- [ ] 实现房间生命周期与座位管理（join/leave/ready）
- [ ] 实现回合计时器与超时自动 `fold`
- [ ] 实现 `rpc-gateway`（jsonrpsee）基础方法
- [ ] 实现 WS PubSub 事件订阅通道
- [ ] 实现 seat 会话公钥绑定（`room.bind_session_keys`）
- [ ] 实现私牌/私有事件加密投递
- [ ] 实现请求签名校验与防重放中间件
- [ ] 实现基础审计落库（`audit_action_attempts` / `audit_behavior_events` / `hand_events`）
- [ ] 实现 Headless Agent Client（最小可用版）
- [ ] 完成多 Bot 假资金对局联调（不接链）

## 2. Phase 2：Conflux 下注校验接入

- [ ] 实现 `chain-watcher` 模块骨架与任务队列
- [ ] 实现 `game.act + tx_hash` 提交流程
- [ ] 实现 `tx_verifications` 落库
- [ ] 实现 `tx_bindings`（`hand_id + action_seq + tx_hash`）绑定
- [ ] 实现 `from/to/value/status/confirmations` 校验规则
- [ ] 实现晚到交易分类（`late`）
- [ ] 实现金额不匹配/异常到账分类（`unmatched`）
- [ ] 实现异常账入账（`exception_credits`）
- [ ] 实现链上校验回投房间 actor 的状态推进逻辑
- [ ] 完成链下+链上混合流程联调测试

## 3. Phase 3：结算上线（房间地址 + 批量合约）

- [ ] 实现 rake 计算规则与舍入逻辑
- [ ] 实现 `settlement-service` 结算计划生成
- [ ] 实现 `ledger_entries` 总账分录落库
- [ ] 实现房间私钥密文托管（`room_signing_keys`，MVP 临时方案）
- [ ] 实现 `AES-256-GCM` 密钥加解密封装（含 `nonce/aad`）
- [ ] 实现房间私钥解密权限边界（仅 `Settlement Service`）
- [ ] 实现结算交易提交与状态跟踪（直转方案）
- [ ] 实现批量合约接口适配（如本期纳入）
- [ ] 实现结算失败重试、告警与人工介入标记
- [ ] 完成牌局结算与账本对账测试

## 4. Phase 4：稳定性、风控与可视化基础

- [ ] 实现限流与背压（RPC/WS/房间队列）
- [ ] 实现审计查询接口（按 `room_id/hand_id/request_id/tx_hash`）
- [ ] 实现管理接口（`/admin/*`）
- [ ] 实现 Prometheus 指标与结构化日志统一字段
- [ ] 实现异常出账/结算失败告警
- [ ] 实现数据表索引优化与必要分区策略
- [ ] 完成多房间并发压测与性能基线
- [ ] 完成回放与可视化读取接口（基于 `hand_events` + `audit_*`）

## 5. 测试与发布控制

- [ ] 建立单元测试规范（规则/账本/安全中间件）
- [ ] 建立集成测试（房间流程、超时、异常动作）
- [ ] 建立端到端测试（多 Bot + 链上模拟/测试网）
- [ ] 建立回归用例集（side pot、all-in、晚到交易、重复请求）
- [ ] 建立灰度/内测发布流程
- [ ] 完成 MVP 验收清单与上线评审
